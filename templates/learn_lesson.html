{% extends "base.html" %}

{% block content %}
<div class="lesson-container">
    <!-- √úst Bar -->
    <div class="lesson-top-bar">
        <a href="{{ url_for('learn') }}" class="close-btn">‚úï</a>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>
        <div class="hearts-display">‚ù§Ô∏è <span id="hearts">5</span></div>
    </div>

    <!-- Soru Kartƒ± -->
    <div class="question-card">
        <p class="question-label" id="questionLabel">Bu kelimenin T√ºrk√ße kar≈üƒ±lƒ±ƒüƒ± nedir?</p>
        
        <!-- Dinleme Butonu (sadece dinleme sorularƒ±nda g√∂r√ºn√ºr) -->
        <div id="listenArea" style="display: none;">
            <button class="listen-btn" id="listenBtn" onclick="playAudio()">
                üîä
            </button>
            <p class="listen-text">Kelimeyi dinle ve anlamƒ±nƒ± se√ß</p>
        </div>
        
        <!-- Normal Soru Kelimesi -->
        <h1 class="question-word" id="questionWord">Y√ºkleniyor...</h1>
        <p class="question-hint" id="questionHint" style="display: none;"></p>
    </div>

    <!-- Se√ßenekler (√ßoktan se√ßmeli) -->
    <div class="options-container" id="optionsContainer">
        <!-- JavaScript ile doldurulacak -->
    </div>

    <!-- Yazƒ± Alanƒ± (√ßeviri i√ßin) -->
    <div class="text-input-container" id="textInputContainer" style="display: none;">
        <input type="text" id="textAnswer" class="text-answer-input" placeholder="Cevabƒ±nƒ± buraya yaz..." autocomplete="off">
    </div>

    <!-- Gramer Yazƒ± Alanƒ± (c√ºmle yazmak i√ßin) -->
    <div class="grammar-container" id="grammarContainer" style="display: none;">
        <textarea id="grammarAnswer" class="grammar-textarea" placeholder="Bu kelimeyi kullanarak bir c√ºmle yaz..." rows="3"></textarea>
        <p class="grammar-example" id="grammarExample"></p>
    </div>

    <!-- Gramer Sonu√ß Alanƒ± -->
    <div class="grammar-result" id="grammarResult" style="display: none;">
        <div class="corrected-sentence" id="correctedSentence"></div>
        <div class="grammar-mistakes" id="grammarMistakes"></div>
    </div>

    <!-- Sonu√ß Mesajƒ± -->
    <div class="result-message" id="resultMessage" style="display: none;">
        <span id="resultText"></span>
    </div>

    <!-- DOƒûRULA BUTONU - HER ZAMAN G√ñR√úN√úR -->
    <div class="action-buttons">
        <button id="validateBtn" class="validate-btn" disabled>DOƒûRULA</button>
    </div>
</div>

<!-- Ders Bitti Modal -->
<div class="complete-modal" id="completeModal" style="display: none;">
    <div class="complete-content">
        <div class="complete-icon">üéâ</div>
        <h2>Ders Tamamlandƒ±!</h2>
        <p>Doƒüru: <span id="correctCount">0</span> / <span id="totalCount">10</span></p>
        <p>XP Kazandƒ±n: <span id="xpEarned">0</span></p>
        <a href="{{ url_for('learn') }}" class="back-to-learn-btn">Kursa D√∂n</a>
    </div>
</div>

<style>
.lesson-container {
    max-width: 500px;
    margin: 0 auto;
    padding: 20px;
    padding-bottom: 100px; /* Sabit buton i√ßin alt bo≈üluk */
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
}

.lesson-top-bar {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
}

.close-btn {
    font-size: 24px;
    color: #888;
    text-decoration: none;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-bar-container {
    flex: 1;
    height: 12px;
    background: #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: #58cc02;
    width: 0%;
    transition: width 0.3s;
    border-radius: 6px;
}

.hearts-display {
    font-size: 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}

.question-card {
    text-align: center;
    padding: 40px 20px;
    margin-bottom: 30px;
}

/* Dƒ∞NLEME BUTONU */
.listen-btn {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, #1cb0f6, #0099e6);
    border: none;
    font-size: 48px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 6px 20px rgba(28, 176, 246, 0.4);
    margin-bottom: 15px;
}

.listen-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(28, 176, 246, 0.5);
}

.listen-btn:active {
    transform: scale(0.95);
}

.listen-btn.playing {
    animation: pulse 0.5s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.listen-text {
    color: #666;
    font-size: 14px;
    margin-top: 10px;
}

.question-label {
    color: #888;
    font-size: 16px;
    margin-bottom: 15px;
}

.question-word {
    font-size: 36px;
    font-weight: 800;
    color: #333;
}

.options-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 30px;
}

.option-btn {
    padding: 20px;
    font-size: 18px;
    font-weight: 600;
    background: white;
    border: 3px solid #e0e0e0;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s;
}

.option-btn:hover {
    border-color: #1cb0f6;
    background: #f0f9ff;
}

.option-btn.selected {
    border-color: #1cb0f6;
    background: #e6f4ff;
}

.option-btn.correct {
    border-color: #58cc02;
    background: #e6ffe6;
}

.option-btn.wrong {
    border-color: #ff4b4b;
    background: #ffe6e6;
}

.option-btn:disabled {
    cursor: not-allowed;
}

/* YAZI ALANI (√áEVƒ∞Rƒ∞ ƒ∞√áƒ∞N) */
.text-input-container {
    margin-bottom: 30px;
}

.text-answer-input {
    width: 100%;
    padding: 20px;
    font-size: 20px;
    font-weight: 600;
    border: 3px solid #e0e0e0;
    border-radius: 16px;
    outline: none;
    transition: all 0.2s;
    text-align: center;
}

.text-answer-input:focus {
    border-color: #1cb0f6;
    box-shadow: 0 0 0 4px rgba(28, 176, 246, 0.1);
}

.text-answer-input.correct {
    border-color: #58cc02;
    background: #e6ffe6;
}

.text-answer-input.wrong {
    border-color: #ff4b4b;
    background: #ffe6e6;
}

.question-hint {
    color: #888;
    font-size: 14px;
    margin-top: 10px;
    font-style: italic;
}

/* GRAMER ALANI */
.grammar-container {
    margin-bottom: 20px;
}

.grammar-textarea {
    width: 100%;
    padding: 20px;
    font-size: 18px;
    font-weight: 500;
    border: 3px solid #e0e0e0;
    border-radius: 16px;
    outline: none;
    resize: none;
    transition: all 0.2s;
    font-family: inherit;
}

.grammar-textarea:focus {
    border-color: #1cb0f6;
    box-shadow: 0 0 0 4px rgba(28, 176, 246, 0.1);
}

.grammar-example {
    color: #888;
    font-size: 14px;
    margin-top: 10px;
    font-style: italic;
}

.grammar-result {
    background: #f8f9fa;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
}

.corrected-sentence {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    padding: 15px;
    background: white;
    border-radius: 12px;
    border-left: 4px solid #58cc02;
}

.grammar-mistakes {
    font-size: 14px;
}

.mistake-item {
    background: #fff3cd;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    border-left: 4px solid #ffc107;
}

.mistake-part {
    font-weight: 700;
    color: #856404;
}

.mistake-explanation {
    color: #666;
    margin-top: 5px;
}

.grammar-loading {
    text-align: center;
    padding: 20px;
    color: #888;
}

.grammar-loading .spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid #e0e0e0;
    border-top-color: #1cb0f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* DOƒûRULA BUTONU - SABƒ∞T ALT PANEL */
.action-buttons {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 15px 20px;
    background: white;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    z-index: 100;
}

.action-buttons .validate-btn {
    max-width: 500px;
    margin: 0 auto;
    display: block;
}

.validate-btn {
    width: 100%;
    padding: 20px;
    font-size: 20px;
    font-weight: 800;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s;
    background: #e0e0e0;
    color: #999;
}

.validate-btn:not(:disabled) {
    background: #58cc02;
    color: white;
    cursor: pointer;
}

.validate-btn:not(:disabled):hover {
    background: #4caf00;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(88, 204, 2, 0.4);
}

.result-message {
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
}

.result-message.correct {
    background: #d4edda;
    color: #155724;
}

.result-message.wrong {
    background: #f8d7da;
    color: #721c24;
}

/* Modal */
.complete-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.complete-content {
    background: white;
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 350px;
}

.complete-icon {
    font-size: 60px;
    margin-bottom: 20px;
}

.complete-content h2 {
    margin-bottom: 20px;
}

.back-to-learn-btn {
    display: inline-block;
    margin-top: 20px;
    padding: 15px 40px;
    background: #58cc02;
    color: white;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 18px;
}

.back-to-learn-btn:hover {
    background: #4caf00;
}
</style>

<script>
const questions = {{ questions | tojson | safe }};
const lessonId = {{ lesson.id }};

let currentQuestion = 0;
let selectedAnswer = null;
let correctAnswers = 0;
let hearts = 5;
let currentAudioText = ''; // Dinleme i√ßin ses metni

// Hatayƒ± sunucuya kaydet
function recordMistake(itemKey, wrongAnswer, correctAnswer, context) {
    fetch('/api/learn/record-mistake', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            item_key: itemKey,
            wrong_answer: wrongAnswer,
            correct_answer: correctAnswer,
            lesson_id: lessonId,
            context: context || 'lesson'
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            console.log('‚úì Hata kaydedildi:', itemKey);
        }
    })
    .catch(err => console.error('Hata kaydetme hatasƒ±:', err));
}

// Web Speech API ile ses √ßal
function playAudio() {
    if (!currentAudioText) return;
    
    const btn = document.getElementById('listenBtn');
    btn.classList.add('playing');
    
    // Web Speech API kullan
    const utterance = new SpeechSynthesisUtterance(currentAudioText);
    utterance.lang = 'en-US';
    utterance.rate = 0.8; // Yava≈ü okusun
    utterance.pitch = 1;
    
    utterance.onend = function() {
        btn.classList.remove('playing');
    };
    
    utterance.onerror = function() {
        btn.classList.remove('playing');
        alert('Ses √ßalƒ±namadƒ±. Tarayƒ±cƒ±nƒ±z Web Speech API desteklemiyor olabilir.');
    };
    
    speechSynthesis.cancel(); // √ñnceki sesi durdur
    speechSynthesis.speak(utterance);
}

document.addEventListener('DOMContentLoaded', function() {
    if (questions.length === 0) {
        document.getElementById('questionWord').textContent = 'Soru bulunamadƒ±';
        return;
    }
    
    loadQuestion();
    
    // DOƒûRULA BUTONUNA TIKLA
    document.getElementById('validateBtn').onclick = function() {
        if (this.textContent === 'DEVAM ET') {
            nextQuestion();
        } else if (selectedAnswer) {
            checkAnswer();
        }
    };
});

function loadQuestion() {
    const q = questions[currentQuestion];
    
    // Progress bar g√ºncelle
    document.getElementById('progressBar').style.width = ((currentQuestion / questions.length) * 100) + '%';
    
    // Konteynerlarƒ± al
    const optionsContainer = document.getElementById('optionsContainer');
    const textInputContainer = document.getElementById('textInputContainer');
    const textAnswer = document.getElementById('textAnswer');
    const questionLabel = document.getElementById('questionLabel');
    const questionHint = document.getElementById('questionHint');
    const questionWord = document.getElementById('questionWord');
    const listenArea = document.getElementById('listenArea');
    const grammarContainer = document.getElementById('grammarContainer');
    const grammarResult = document.getElementById('grammarResult');
    
    // Reset
    optionsContainer.innerHTML = '';
    optionsContainer.style.display = 'none';
    textInputContainer.style.display = 'none';
    questionHint.style.display = 'none';
    listenArea.style.display = 'none';
    grammarContainer.style.display = 'none';
    grammarResult.style.display = 'none';
    questionWord.style.display = 'block';
    selectedAnswer = null;
    currentAudioText = '';
    
    // Gramer alanlarƒ±nƒ± temizle ve resetle
    const grammarTextarea = document.getElementById('grammarAnswer');
    grammarTextarea.value = '';
    grammarTextarea.disabled = false;  // √ñNEMLƒ∞: disabled'ƒ± kaldƒ±r
    document.getElementById('correctedSentence').innerHTML = '';
    document.getElementById('grammarMistakes').innerHTML = '';
    
    // Soru tipine g√∂re g√∂ster
    if (q.type === 'grammar') {
        // GRAMER SORUSU - Kelimeyi kullanarak c√ºmle yaz
        questionLabel.textContent = 'Bu kelimeyi kullanarak bir c√ºmle yaz:';
        questionWord.textContent = q.question;
        grammarContainer.style.display = 'block';
        
        // √ñrnek c√ºmle varsa g√∂ster
        const grammarExample = document.getElementById('grammarExample');
        if (q.hint) {
            grammarExample.textContent = '√ñrnek: ' + q.hint;
            grammarExample.style.display = 'block';
        } else {
            grammarExample.style.display = 'none';
        }
        
        // Yazƒ± alanƒ± event
        const grammarTextarea = document.getElementById('grammarAnswer');
        grammarTextarea.oninput = function() {
            selectedAnswer = this.value.trim();
            document.getElementById('validateBtn').disabled = !selectedAnswer;
        };
        
        // Focus
        grammarTextarea.focus();
        
    } else if (q.type === 'listen_select') {
        // Dƒ∞NLEME SORUSU - Kelimeyi gizle, ses butonu g√∂ster
        questionLabel.textContent = 'Dinle ve T√ºrk√ße kar≈üƒ±lƒ±ƒüƒ±nƒ± se√ß:';
        questionWord.style.display = 'none'; // Kelimeyi gizle!
        listenArea.style.display = 'block';
        currentAudioText = q.audio_text || q.question; // Okunacak kelime
        
        // Se√ßenekleri g√∂ster
        optionsContainer.style.display = 'grid';
        const shuffled = [...q.options].sort(() => Math.random() - 0.5);
        shuffled.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = function() {
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedAnswer = opt;
                document.getElementById('validateBtn').disabled = false;
            };
            optionsContainer.appendChild(btn);
        });
        
        // Sayfa y√ºklenince otomatik oku
        setTimeout(() => playAudio(), 500);
        
    } else if (q.type === 'turkish_to_word' || q.type === 'fill_blank') {
        // YAZI ALANI G√ñSTER (√áeviri i√ßin)
        questionLabel.textContent = q.type === 'turkish_to_word' ? 'Bu kelimenin ƒ∞ngilizce kar≈üƒ±lƒ±ƒüƒ±nƒ± yaz:' : 'Bo≈üluƒüu doldur:';
        questionWord.textContent = q.question;
        textInputContainer.style.display = 'block';
        textAnswer.value = '';
        textAnswer.disabled = false;
        textAnswer.className = 'text-answer-input';
        
        // ƒ∞pucu varsa g√∂ster
        if (q.hint) {
            questionHint.textContent = 'ƒ∞pucu: ' + q.hint;
            questionHint.style.display = 'none';
        }
        
        // Yazƒ± alanƒ± event
        textAnswer.oninput = function() {
            selectedAnswer = this.value.trim();
            document.getElementById('validateBtn').disabled = !selectedAnswer;
        };
        
        // Enter tu≈üu
        textAnswer.onkeypress = function(e) {
            if (e.key === 'Enter' && selectedAnswer) {
                checkAnswer();
            }
        };
        
        // Focus
        textAnswer.focus();
        
    } else {
        // SE√áENEK BUTONLARI G√ñSTER (Kelime i√ßin - word_to_turkish)
        questionLabel.textContent = 'Bu kelimenin T√ºrk√ße kar≈üƒ±lƒ±ƒüƒ± nedir?';
        questionWord.textContent = q.question;
        optionsContainer.style.display = 'grid';
        
        // Se√ßenekleri karƒ±≈ütƒ±r
        const shuffled = [...q.options].sort(() => Math.random() - 0.5);
        
        shuffled.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            btn.onclick = function() {
                // √ñnceki se√ßimi kaldƒ±r
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                // Bu se√ßeneƒüi se√ß
                this.classList.add('selected');
                selectedAnswer = opt;
                // DOƒûRULA butonunu aktif et
                document.getElementById('validateBtn').disabled = false;
            };
            optionsContainer.appendChild(btn);
        });
    }
    
    // Validate butonu reset
    const validateBtn = document.getElementById('validateBtn');
    validateBtn.disabled = true;
    validateBtn.textContent = 'DOƒûRULA';
    document.getElementById('resultMessage').style.display = 'none';
}

function checkAnswer() {
    const q = questions[currentQuestion];
    const resultDiv = document.getElementById('resultMessage');
    const resultText = document.getElementById('resultText');
    const textAnswer = document.getElementById('textAnswer');
    
    // GRAMER SORUSU ƒ∞√áƒ∞N √ñZEL ƒ∞≈ûLEM
    if (q.type === 'grammar') {
        checkGrammarAnswer();
        return;
    }
    
    // Cevabƒ± kar≈üƒ±la≈ütƒ±r (k√º√ß√ºk harfle, bo≈üluklarƒ± temizleyerek)
    const userAnswer = selectedAnswer.toLowerCase().trim();
    const correctAnswer = q.answer.toLowerCase().trim();
    const isCorrect = userAnswer === correctAnswer;
    
    // Se√ßenek butonlarƒ±nƒ± i≈üle
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.disabled = true;
        if (btn.textContent.toLowerCase().trim() === correctAnswer) {
            btn.classList.add('correct');
        }
        if (btn.classList.contains('selected') && btn.textContent.toLowerCase().trim() !== correctAnswer) {
            btn.classList.add('wrong');
        }
    });
    
    // Yazƒ± alanƒ±nƒ± i≈üle
    if (textAnswer && textAnswer.style.display !== 'none') {
        textAnswer.disabled = true;
        if (isCorrect) {
            textAnswer.classList.add('correct');
        } else {
            textAnswer.classList.add('wrong');
        }
    }
    
    if (isCorrect) {
        // DOƒûRU
        correctAnswers++;
        resultDiv.className = 'result-message correct';
        resultText.textContent = '‚úì Doƒüru!';
    } else {
        // YANLI≈û - Hatayƒ± kaydet
        recordMistake(q.question, selectedAnswer, q.answer, q.type);
        
        if (hearts > 0) {
            hearts--;
        }
        document.getElementById('hearts').textContent = hearts;
        
        if (hearts === 0) {
            // Can bitti
            resultDiv.className = 'result-message wrong';
            resultText.textContent = '‚ùå Can hakkƒ±nƒ±z bitti! Ders sonlandƒ±rƒ±lƒ±yor...';
            resultDiv.style.display = 'block';
            
            // 2 saniye sonra dersi bitir
            setTimeout(() => {
                finishLessonEarly();
            }, 2000);
            
            // Devam butonu devre dƒ±≈üƒ±
            const validateBtn = document.getElementById('validateBtn');
            validateBtn.disabled = true;
        } else {
            resultDiv.className = 'result-message wrong';
            resultText.textContent = '‚úó Yanlƒ±≈ü! Doƒüru cevap: ' + q.answer;
        }
    }
    
    resultDiv.style.display = 'block';
    
    // DOƒûRULA butonunu DEVAM ET yap
    const validateBtn = document.getElementById('validateBtn');
    validateBtn.textContent = 'DEVAM ET';
    validateBtn.disabled = false;
}

// GRAMER CEVABINI KONTROL ET (LLM ile)
async function checkGrammarAnswer() {
    const q = questions[currentQuestion];
    const sentence = selectedAnswer;
    const targetWord = q.question;
    
    const validateBtn = document.getElementById('validateBtn');
    const grammarResult = document.getElementById('grammarResult');
    const correctedSentence = document.getElementById('correctedSentence');
    const grammarMistakes = document.getElementById('grammarMistakes');
    const resultDiv = document.getElementById('resultMessage');
    const resultText = document.getElementById('resultText');
    const grammarTextarea = document.getElementById('grammarAnswer');
    
    // Y√ºkleniyor g√∂ster
    validateBtn.disabled = true;
    validateBtn.innerHTML = '<span class="spinner"></span> Kontrol ediliyor...';
    grammarTextarea.disabled = true;
    
    try {
        const response = await fetch('/api/check-grammar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                sentence: sentence,
                target_word: targetWord 
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Sonucu g√∂ster
        grammarResult.style.display = 'block';
        
        // D√ºzeltilmi≈ü c√ºmle
        if (data.corrected && data.corrected !== sentence) {
            correctedSentence.innerHTML = '<strong>‚úèÔ∏è D√ºzeltilmi≈ü:</strong> ' + data.corrected;
            correctedSentence.style.display = 'block';
        } else if (data.is_correct) {
            correctedSentence.innerHTML = '<strong>‚úì</strong> C√ºmlen doƒüru!';
            correctedSentence.style.display = 'block';
            correctedSentence.style.borderLeftColor = '#58cc02';
        } else {
            correctedSentence.style.display = 'none';
        }
        
        // Hatalar
        grammarMistakes.innerHTML = '';
        if (data.mistakes && data.mistakes.length > 0) {
            data.mistakes.forEach(mistake => {
                const mistakeDiv = document.createElement('div');
                mistakeDiv.className = 'mistake-item';
                mistakeDiv.innerHTML = `
                    <span class="mistake-part">"${mistake.part}"</span>
                    <span class="mistake-explanation">${mistake.explanation_tr}</span>
                `;
                grammarMistakes.appendChild(mistakeDiv);
            });
        }
        
        // Kelime kullanƒ±lmadƒ± uyarƒ±sƒ±
        if (!data.word_used) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'mistake-item';
            warningDiv.innerHTML = `
                <span class="mistake-part">‚ö†Ô∏è Uyarƒ±</span>
                <span class="mistake-explanation">C√ºmlede "${targetWord}" kelimesini kullanmalƒ±sƒ±n!</span>
            `;
            grammarMistakes.appendChild(warningDiv);
        }
        
        // Sonu√ß mesajƒ±
        if (data.is_correct) {
            correctAnswers++;
            resultDiv.className = 'result-message correct';
            resultText.textContent = '‚úì Harika! C√ºmlen doƒüru.';
        } else {
            // YANLI≈û - Hatayƒ± kaydet
            recordMistake(targetWord, sentence, data.corrected || q.answer, 'grammar');
            
            if (hearts > 0) {
                hearts--;
            }
            document.getElementById('hearts').textContent = hearts;
            
            if (hearts === 0) {
                // Can bitti
                resultDiv.className = 'result-message wrong';
                resultText.textContent = '‚ùå Can hakkƒ±nƒ±z bitti! Ders sonlandƒ±rƒ±lƒ±yor...';
                
                // 2 saniye sonra dersi bitir
                setTimeout(() => {
                    finishLessonEarly();
                }, 2000);
                
                // Devam butonu devre dƒ±≈üƒ±
                validateBtn.disabled = true;
            } else {
                resultDiv.className = 'result-message wrong';
                resultText.textContent = '‚úó Bazƒ± d√ºzeltmeler gerekiyor.';
            }
        }
        
        resultDiv.style.display = 'block';
        
    } catch (error) {
        console.error('Gramer kontrol hatasƒ±:', error);
        resultDiv.className = 'result-message wrong';
        resultText.textContent = '‚ö†Ô∏è Gramer kontrol√º yapƒ±lamadƒ±: ' + error.message;
        resultDiv.style.display = 'block';
    }
    
    // DEVAM ET butonu
    validateBtn.innerHTML = 'DEVAM ET';
    validateBtn.textContent = 'DEVAM ET';
    validateBtn.disabled = false;
}

function nextQuestion() {
    currentQuestion++;
    
    if (currentQuestion >= questions.length) {
        // Ders bitti
        finishLesson();
    } else {
        // Sonraki soru
        loadQuestion();
    }
}

function finishLesson() {
    const score = Math.round((correctAnswers / questions.length) * 100);
    
    // API'ye g√∂nder
    fetch('/api/learn/complete-lesson', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lesson_id: lessonId, score: score })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById('correctCount').textContent = correctAnswers;
        document.getElementById('totalCount').textContent = questions.length;
        document.getElementById('xpEarned').textContent = data.xp_earned || 0;
        document.getElementById('completeModal').style.display = 'flex';
    })
    .catch(err => {
        document.getElementById('correctCount').textContent = correctAnswers;
        document.getElementById('totalCount').textContent = questions.length;
        document.getElementById('completeModal').style.display = 'flex';
    });
}

function finishLessonEarly() {
    // Can bitti nedeniyle derse erken son verilmi≈ü
    const score = Math.round((correctAnswers / questions.length) * 100);
    
    // API'ye g√∂nder
    fetch('/api/learn/complete-lesson', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lesson_id: lessonId, score: score })
    })
    .then(res => res.json())
    .then(data => {
        const modalContent = document.querySelector('.complete-content');
        const modal = document.getElementById('completeModal');
        
        // Modal i√ßeriƒüini deƒüi≈ütir
        document.getElementById('correctCount').textContent = correctAnswers;
        document.getElementById('totalCount').textContent = questions.length;
        document.getElementById('xpEarned').textContent = '0';
        
        // Ba≈ülƒ±ƒüƒ± deƒüi≈ütir
        const icon = modalContent.querySelector('.complete-icon');
        const h2 = modalContent.querySelector('h2');
        icon.textContent = '‚ùå';
        h2.textContent = 'Can Hakkƒ±nƒ±z Bitti!';
        
        modal.style.display = 'flex';
    })
    .catch(err => {
        const modalContent = document.querySelector('.complete-content');
        const modal = document.getElementById('completeModal');
        
        document.getElementById('correctCount').textContent = correctAnswers;
        document.getElementById('totalCount').textContent = questions.length;
        document.getElementById('xpEarned').textContent = '0';
        
        const icon = modalContent.querySelector('.complete-icon');
        const h2 = modalContent.querySelector('h2');
        icon.textContent = '‚ùå';
        h2.textContent = 'Can Hakkƒ±nƒ±z Bitti!';
        
        modal.style.display = 'flex';
    });
}
</script>
{% endblock %}
