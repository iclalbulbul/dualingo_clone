{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="card-title mb-3">
                    <i class="bi bi-mic text-danger"></i> Telaffuz PratiÄŸi
                </h3>
                <p class="text-muted">KullanÄ±cÄ±: {{ username }}</p>

                <!-- SonuÃ§ GÃ¶sterimi (EÄŸer Varsa - EN ÃœSTTE) -->
                {% if score is not none %}
                <div class="result-section mb-4" id="resultSection">
                    <div class="card {% if is_correct %}border-success bg-success bg-opacity-10{% else %}border-danger bg-danger bg-opacity-10{% endif %}">
                        <div class="card-body text-center">
                            <h5 class="text-muted mb-2">ðŸ“Š Telaffuz DeÄŸerlendirmesi</h5>
                            
                            <!-- Kelime KarÅŸÄ±laÅŸtÄ±rma -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="card bg-white">
                                        <div class="card-body py-2">
                                            <small class="text-muted">Hedef Kelime</small>
                                            <h4 class="text-primary mb-0">{{ target_word }}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-white">
                                        <div class="card-body py-2">
                                            <small class="text-muted">SÃ¶ylediÄŸin</small>
                                            <h4 class="{% if is_correct %}text-success{% else %}text-danger{% endif %} mb-0">{{ recognized or '-' }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Skor -->
                            <div class="position-relative d-inline-block mb-3">
                                <svg width="120" height="120" viewBox="0 0 36 36">
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                        fill="none" stroke="#eee" stroke-width="3"/>
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                        fill="none"
                                        stroke="{% if score >= 80 %}#28a745{% elif score >= 50 %}#ffc107{% else %}#dc3545{% endif %}"
                                        stroke-width="3"
                                        stroke-dasharray="{{ score }}, 100"/>
                                    <text x="18" y="20.5" text-anchor="middle" font-size="8" fill="{% if score >= 80 %}#28a745{% elif score >= 50 %}#ffc107{% else %}#dc3545{% endif %}" font-weight="bold">{{ score }}%</text>
                                </svg>
                            </div>
                            
                            {% if is_correct %}
                            <div class="alert alert-success mb-2">
                                <i class="bi bi-check-circle-fill fs-4"></i>
                                <h5 class="mt-2 mb-0">Harika! ðŸŽ‰</h5>
                            </div>
                            {% else %}
                            <div class="alert alert-warning mb-2">
                                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                <h5 class="mt-2 mb-0">Tekrar Dene! ðŸ’ª</h5>
                            </div>
                            {% endif %}
                            
                            {% if feedback %}
                            <p class="text-muted mb-0"><i class="bi bi-chat-left-text"></i> {{ feedback }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Butonlar -->
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <button type="button" class="btn btn-outline-primary" onclick="retryWord()">
                            <i class="bi bi-arrow-repeat"></i> AynÄ± Kelimeyi Tekrarla
                        </button>
                        <a href="{{ url_for('pronunciation') }}" class="btn btn-primary">
                            <i class="bi bi-arrow-right"></i> Yeni Kelime
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Hedef Kelime KartÄ± -->
                <div class="card bg-light mb-4">
                    <div class="card-body text-center">
                        <p class="text-muted mb-1">{% if score is not none %}Kelime:{% else %}Bu kelimeyi telaffuz et:{% endif %}</p>
                        <h1 class="display-4 text-primary fw-bold" id="targetWord">{{ target_word }}</h1>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="speakWord('{{ target_word }}')">
                            <i class="bi bi-volume-up"></i> Dinle
                        </button>
                    </div>
                </div>

                <!-- Mikrofon KayÄ±t AlanÄ± -->
                <div class="card border-warning mb-4">
                    <div class="card-body text-center">
                        <div id="recordingStatus" class="mb-3">
                            <i class="bi bi-mic-fill text-secondary fs-1"></i>
                            <p class="text-muted mt-2">Mikrofona tÄ±kla ve kelimeyi sÃ¶yle</p>
                        </div>
                        
                        <!-- KayÄ±t Butonu -->
                        <button type="button" id="recordBtn" class="btn btn-danger btn-lg rounded-circle" style="width: 80px; height: 80px;" onclick="startListening()">
                            <i class="bi bi-mic-fill fs-3" id="recordIcon"></i>
                        </button>
                        
                        <p id="recordingText" class="mt-2 text-muted">KayÄ±t iÃ§in tÄ±kla</p>
                        
                        <!-- Ses DalgasÄ± Animasyonu -->
                        <div id="audioWave" class="d-none mt-3">
                            <div class="d-flex justify-content-center align-items-end" style="height: 40px;">
                                <div class="bg-danger mx-1 audio-bar" style="width: 4px;"></div>
                                <div class="bg-danger mx-1 audio-bar" style="width: 4px;"></div>
                                <div class="bg-danger mx-1 audio-bar" style="width: 4px;"></div>
                                <div class="bg-danger mx-1 audio-bar" style="width: 4px;"></div>
                                <div class="bg-danger mx-1 audio-bar" style="width: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AlgÄ±lanan Metin GÃ¶sterimi -->
                <div id="recognizedDisplay" class="alert alert-info d-none mb-4">
                    <strong><i class="bi bi-chat-quote"></i> AlgÄ±lanan:</strong>
                    <span id="recognizedSpan"></span>
                    <button type="button" class="btn btn-sm btn-primary ms-2" onclick="submitResult()">
                        <i class="bi bi-check"></i> DeÄŸerlendir
                    </button>
                </div>

                <!-- Form -->
                <form method="post" id="pronunciationForm">
                    <input type="hidden" name="user_pronunciation" id="recognizedText">
                    <input type="hidden" name="word_id" value="{{ word_id }}">
                    <input type="hidden" name="target_word" value="{{ target_word }}">
                </form>

                <!-- Ana Sayfa Butonu -->
                {% if score is none %}
                <div class="text-center mt-4">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Ana Sayfa
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.audio-bar {
    animation: audioWave 0.5s ease-in-out infinite alternate;
}
.audio-bar:nth-child(1) { animation-delay: 0s; height: 10px; }
.audio-bar:nth-child(2) { animation-delay: 0.1s; height: 20px; }
.audio-bar:nth-child(3) { animation-delay: 0.2s; height: 30px; }
.audio-bar:nth-child(4) { animation-delay: 0.1s; height: 20px; }
.audio-bar:nth-child(5) { animation-delay: 0s; height: 10px; }

@keyframes audioWave {
    from { height: 10px; }
    to { height: 35px; }
}

#recordBtn.recording {
    animation: pulse 1s infinite;
    background-color: #dc3545 !important;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}
</style>

<script>
// Web Speech API kullanarak tarayÄ±cÄ±da STT
let recognition = null;
let isListening = false;

// Text-to-Speech
function speakWord(word) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        speechSynthesis.speak(utterance);
    } else {
        alert('TarayÄ±cÄ±nÄ±z Text-to-Speech desteklemiyor.');
    }
}

// Speech Recognition baÅŸlat
function startListening() {
    // Web Speech API desteÄŸi kontrol
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('TarayÄ±cÄ±nÄ±z ses tanÄ±ma desteklemiyor. Chrome veya Edge kullanÄ±n.');
        return;
    }
    
    if (isListening) {
        stopListening();
        return;
    }
    
    // SpeechRecognition oluÅŸtur
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;
    
    recognition.onstart = function() {
        isListening = true;
        document.getElementById('recordBtn').classList.add('recording');
        document.getElementById('recordIcon').className = 'bi bi-stop-fill fs-3';
        document.getElementById('recordingText').textContent = 'Dinleniyor... KonuÅŸ!';
        document.getElementById('audioWave').classList.remove('d-none');
        document.getElementById('recordingStatus').innerHTML = '<i class="bi bi-mic-fill text-danger fs-1"></i><p class="text-danger mt-2 fw-bold">ðŸ”´ Dinleniyor...</p>';
    };
    
    recognition.onresult = function(event) {
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        // Sonucu gÃ¶ster
        const displayText = finalTranscript || interimTranscript;
        if (displayText) {
            document.getElementById('recognizedSpan').textContent = displayText;
            document.getElementById('recognizedDisplay').classList.remove('d-none');
            document.getElementById('recognizedText').value = displayText;
        }
    };
    
    recognition.onerror = function(event) {
        console.error('STT Hata:', event.error);
        let errorMsg = 'Ses tanÄ±ma hatasÄ±';
        
        switch(event.error) {
            case 'no-speech':
                errorMsg = 'Ses algÄ±lanamadÄ±. Tekrar dene.';
                break;
            case 'audio-capture':
                errorMsg = 'Mikrofon bulunamadÄ±.';
                break;
            case 'not-allowed':
                errorMsg = 'Mikrofon izni verilmedi.';
                break;
            case 'network':
                errorMsg = 'AÄŸ hatasÄ±.';
                break;
        }
        
        document.getElementById('recordingStatus').innerHTML = `
            <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
            <p class="text-danger mt-2">${errorMsg}</p>
        `;
        stopListening();
    };
    
    recognition.onend = function() {
        stopListening();
    };
    
    // Dinlemeyi baÅŸlat
    recognition.start();
}

function stopListening() {
    isListening = false;
    if (recognition) {
        recognition.stop();
    }
    document.getElementById('recordBtn').classList.remove('recording');
    document.getElementById('recordIcon').className = 'bi bi-mic-fill fs-3';
    document.getElementById('recordingText').textContent = 'Tekrar kayÄ±t iÃ§in tÄ±kla';
    document.getElementById('audioWave').classList.add('d-none');
    
    // EÄŸer sonuÃ§ varsa durumu gÃ¼ncelle
    const recognized = document.getElementById('recognizedText').value;
    if (recognized) {
        document.getElementById('recordingStatus').innerHTML = '<i class="bi bi-check-circle text-success fs-1"></i><p class="text-success mt-2">Ses algÄ±landÄ±!</p>';
    } else {
        document.getElementById('recordingStatus').innerHTML = '<i class="bi bi-mic-fill text-secondary fs-1"></i><p class="text-muted mt-2">Mikrofona tÄ±kla ve kelimeyi sÃ¶yle</p>';
    }
}

function submitResult() {
    const recognized = document.getElementById('recognizedText').value;
    if (recognized) {
        document.getElementById('pronunciationForm').submit();
    }
}

// AynÄ± kelimeyi tekrar denemek iÃ§in
function retryWord() {
    // SonuÃ§ bÃ¶lÃ¼mÃ¼nÃ¼ gizle (varsa)
    const resultSection = document.getElementById('resultSection');
    if (resultSection) {
        resultSection.style.display = 'none';
    }
    
    // AlgÄ±lanan metni temizle
    document.getElementById('recognizedText').value = '';
    document.getElementById('recognizedSpan').textContent = '';
    document.getElementById('recognizedDisplay').classList.add('d-none');
    document.getElementById('recordingStatus').innerHTML = '<i class="bi bi-mic-fill text-secondary fs-1"></i><p class="text-muted mt-2">Mikrofona tÄ±kla ve kelimeyi sÃ¶yle</p>';
    
    // Mikrofon alanÄ±na scroll
    document.querySelector('.border-warning').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Sayfa yÃ¼klendiÄŸinde otomatik mikrofon izni iste
document.addEventListener('DOMContentLoaded', function() {
    // EÄŸer sonuÃ§ varsa sayfanÄ±n en Ã¼stÃ¼ne scroll
    const resultSection = document.getElementById('resultSection');
    if (resultSection) {
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Mikrofon iznini kontrol et
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                // Ä°zin verildi, stream'i kapat
                stream.getTracks().forEach(track => track.stop());
                console.log('Mikrofon izni verildi');
            })
            .catch(function(err) {
                console.log('Mikrofon izni hatasÄ±:', err);
            });
    }
});
</script>
{% endblock %}
