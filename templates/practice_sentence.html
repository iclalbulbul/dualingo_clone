{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="card-title mb-3">
                    <i class="bi bi-chat-text text-success"></i> CÃ¼mle & Grammar PratiÄŸi
                </h3>
                <p class="text-muted">KullanÄ±cÄ±: {{ username }}</p>

                <!-- Ã–rnek CÃ¼mle KartÄ± (GET isteÄŸinde gÃ¶ster) -->
                {% if example_sentence and not feedback %}
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">
                            <i class="bi bi-lightbulb text-warning"></i> Ã–rnek CÃ¼mle:
                        </h6>
                        <p class="lead mb-2">{{ example_sentence }}</p>
                        {% if target_word %}
                        <small class="text-muted">Hedef kelime: <span class="badge bg-primary">{{ target_word }}</span></small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <form method="post" class="mb-4">
                    {% if target_word %}
                    <input type="hidden" name="target_word" value="{{ target_word }}">
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-pencil"></i> Ä°ngilizce bir cÃ¼mle yaz:
                        </label>
                        <textarea name="sentence" 
                                  class="form-control form-control-lg" 
                                  rows="3" 
                                  placeholder="Ã–rn: I like to read books every day."
                                  required>{{ user_sentence or "" }}</textarea>
                        <div class="form-text">
                            ðŸ’¡ Basit, anlaÅŸÄ±lÄ±r cÃ¼mleler kur. Ã–zne + Fiil + Nesne yapÄ±sÄ±nÄ± kullan.
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Analiz Et
                        </button>
                        <a href="{{ url_for('practice_sentence') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-repeat"></i> Yeni Ã–rnek
                        </a>
                    </div>
                </form>

                {% if feedback %}
                <!-- Skor GÃ¶stergesi -->
                <div class="card {% if feedback.is_valid %}border-success{% else %}border-warning{% endif %} mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4 text-center">
                                <div class="position-relative d-inline-block">
                                    <svg width="120" height="120" viewBox="0 0 36 36">
                                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none" stroke="#eee" stroke-width="3"/>
                                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                            fill="none"
                                            stroke="{% if feedback.score >= 80 %}#28a745{% elif feedback.score >= 60 %}#ffc107{% else %}#dc3545{% endif %}"
                                            stroke-width="3"
                                            stroke-dasharray="{{ feedback.score }}, 100"/>
                                        <text x="18" y="20.5" text-anchor="middle" font-size="8" 
                                              fill="{% if feedback.score >= 80 %}#28a745{% elif feedback.score >= 60 %}#ffc107{% else %}#dc3545{% endif %}" 
                                              font-weight="bold">{{ feedback.score }}</text>
                                    </svg>
                                </div>
                                <p class="text-muted mt-2 mb-0">Puan</p>
                            </div>
                            <div class="col-md-8">
                                {% if feedback.is_valid %}
                                <div class="alert alert-success mb-0">
                                    <h5><i class="bi bi-check-circle-fill"></i> Harika! ðŸŽ‰</h5>
                                    <p class="mb-0">CÃ¼mleniz gramer aÃ§Ä±sÄ±ndan doÄŸru!</p>
                                </div>
                                {% else %}
                                <div class="alert alert-warning mb-0">
                                    <h5><i class="bi bi-exclamation-triangle-fill"></i> Dikkat!</h5>
                                    <p class="mb-0">CÃ¼mlenizde bazÄ± hatalar var. AÅŸaÄŸÄ±daki Ã¶nerileri inceleyin.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hata Listesi -->
                {% if feedback.errors %}
                <div class="card border-danger mb-3">
                    <div class="card-header bg-danger text-white">
                        <i class="bi bi-x-circle"></i> Tespit Edilen Hatalar ({{ feedback.errors|length }})
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% for error in feedback.errors %}
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="badge bg-secondary me-2">{{ error.rule }}</span>
                                        <span>{{ error.message_tr }}</span>
                                        {% if error.correct_verb %}
                                        <br><small class="text-success">DoÄŸru: <strong>{{ error.correct_verb }}</strong></small>
                                        {% endif %}
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}

                <!-- AI Geri Bildirimi -->
                {% if ai_feedback %}
                <div class="card border-info mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-robot"></i> AI DeÄŸerlendirmesi
                    </div>
                    <div class="card-body">
                        {% if ai_feedback.corrected and ai_feedback.corrected != user_sentence %}
                        <div class="mb-3">
                            <h6 class="text-muted">DÃ¼zeltilmiÅŸ CÃ¼mle:</h6>
                            <p class="lead text-success">{{ ai_feedback.corrected }}</p>
                        </div>
                        {% endif %}
                        
                        {% if ai_feedback.mistakes %}
                        <h6 class="text-muted">DetaylÄ± AÃ§Ä±klamalar:</h6>
                        <ul class="list-unstyled">
                            {% for mistake in ai_feedback.mistakes %}
                            <li class="mb-2">
                                <i class="bi bi-arrow-right text-info"></i>
                                <strong>"{{ mistake.part }}"</strong>: {{ mistake.explanation_tr }}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Ã–neriler -->
                {% if feedback.suggestions %}
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-lightbulb"></i> Ã–neriler
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            {% for suggestion in feedback.suggestions %}
                            <li>{{ suggestion }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
                {% endif %}

                <!-- Alt Butonlar -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Ana Sayfa
                    </a>
                    <a href="{{ url_for('practice_sentence') }}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Yeni CÃ¼mle Yaz
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
